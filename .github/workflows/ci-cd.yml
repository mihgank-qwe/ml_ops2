name: CI/CD

on:
  push:
    branches: [main, master, develop]
    tags: ['v*']
  pull_request:
    branches: [main, master, develop]

env:
  IMAGE_NAME: credit-scoring-api

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt flake8 black

      - name: Run Black
        run: black --check src tests

      - name: Run Flake8
        run: flake8 src tests --max-line-length=88 --extend-ignore=E203,W503

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.29.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true
          skip-dirs: 'data,.git,__pycache__,.pytest_cache'

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest flake8 black

      - name: Get dataset
        run: |
          mkdir -p data/raw
          if [ ! -f data/raw/UCI_Credit_Card.csv ]; then
            pip install xlrd
            curl -L -o data.zip "https://archive.ics.uci.edu/static/public/350/default+of+credit+card+clients.zip"
            unzip -o data.zip
            python -c "
import pandas as pd
df = pd.read_excel('default of credit card clients.xls', header=1)
df.to_csv('data/raw/UCI_Credit_Card.csv', index=False)
"
          fi

      - name: Prepare data
        run: |
          python src/data/make_dataset.py data/raw/UCI_Credit_Card.csv data/processed/

      - name: Валидация данных (Pandera)
        run: python -c "
from src.data.validation import validate_data_file
from pathlib import Path
train_path = Path('data/processed/train.csv')
assert train_path.exists(), 'Данные train не найдены'
validate_data_file(train_path)
print('Валидация Pandera пройдена')
"

      - name: Валидация данных (Great Expectations)
        run: |
          pip install great-expectations==0.18.21
          python scripts/validate_ge.py

      - name: Run tests
        run: pytest tests -v

  build-and-push-docker:
    name: Build and Push Docker
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    outputs:
      image: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/develop' }}
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          load: true
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get image ref for scan
        id: img
        run: |
          REF=$(echo "${{ steps.meta.outputs.tags }}" | cut -d',' -f1)
          echo "ref=$REF" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ steps.img.outputs.ref }}
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      - name: Run Dockle container linter
        uses: goodwithtech/dockle-action@v0.4.15
        with:
          image: ${{ steps.img.outputs.ref }}
          exit-code: '1'
          exit-level: 'FATAL'

      - name: Push Docker image
        if: github.event_name != 'pull_request'
        run: |
          for tag in $(echo "${{ steps.meta.outputs.tags }}" | tr ',' ' '); do
            docker push "$tag"
          done

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    if: (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v')) && github.event_name != 'pull_request'
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.28.0"

      - name: Set up kubeconfig (KUBECONFIG)
        if: vars.AUTH_METHOD != 'yandex'
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_CONTENT" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Set up kubeconfig (Yandex Cloud)
        if: vars.AUTH_METHOD == 'yandex'
        env:
          YC_SA_KEY: ${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}
          YC_CLUSTER_ID: ${{ vars.YANDEX_CLUSTER_ID }}
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH="$HOME/yandex-cloud/bin:$HOME/.local/bin:$PATH"
          echo "$YC_SA_KEY" > sa-key.json
          yc config profile create ci --service-account-key sa-key.json
          yc config profile activate ci
          yc managed-kubernetes cluster get-credentials "$YC_CLUSTER_ID" --external --force
          rm -f sa-key.json

      - name: Ensure namespace exists
        run: kubectl create namespace staging --dry-run=client -o yaml | kubectl apply -f -

      - name: Update deployment image
        env:
          IMAGE_TAGS: ${{ needs.build-and-push-docker.outputs.image }}
        run: |
          IMAGE_FULL=$(echo "$IMAGE_TAGS" | cut -d',' -f1)
          sed -i "s|image: .*|image: ${IMAGE_FULL}|g" deployment/kubernetes/deployment.yaml

      - name: Update Ingress host (staging)
        if: vars.INGRESS_HOST != ''
        env:
          HOST: ${{ vars.INGRESS_HOST }}
        run: sed -i "s|host: .*|host: ${HOST}|g" deployment/kubernetes/ingress.yaml

      - name: Deploy to Staging
        run: kubectl apply -f deployment/kubernetes/ -n staging

      - name: Wait for deployment
        run: kubectl rollout status deployment/credit-scoring-api -n staging --timeout=300s

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name != 'pull_request'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.28.0"

      - name: Set up kubeconfig (KUBECONFIG)
        if: vars.AUTH_METHOD != 'yandex'
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_CONTENT" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Set up kubeconfig (Yandex Cloud)
        if: vars.AUTH_METHOD == 'yandex'
        env:
          YC_SA_KEY: ${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}
          YC_CLUSTER_ID: ${{ vars.YANDEX_CLUSTER_ID }}
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH="$HOME/yandex-cloud/bin:$HOME/.local/bin:$PATH"
          echo "$YC_SA_KEY" > sa-key.json
          yc config profile create ci --service-account-key sa-key.json
          yc config profile activate ci
          yc managed-kubernetes cluster get-credentials "$YC_CLUSTER_ID" --external --force
          rm -f sa-key.json

      - name: Ensure namespace exists
        run: kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -

      - name: Update deployment image
        env:
          IMAGE_TAGS: ${{ needs.build-and-push-docker.outputs.image }}
        run: |
          IMAGE_FULL=$(echo "$IMAGE_TAGS" | cut -d',' -f1)
          sed -i "s|image: .*|image: ${IMAGE_FULL}|g" deployment/kubernetes/deployment.yaml

      - name: Update Ingress host (production)
        if: vars.INGRESS_HOST != ''
        env:
          HOST: ${{ vars.INGRESS_HOST }}
        run: sed -i "s|host: .*|host: ${HOST}|g" deployment/kubernetes/ingress.yaml

      - name: Deploy to Production
        run: kubectl apply -f deployment/kubernetes/ -n production

      - name: Wait for deployment
        run: kubectl rollout status deployment/credit-scoring-api -n production --timeout=300s
