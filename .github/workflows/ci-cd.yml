name: CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest flake8 black

      - name: Get dataset
        run: |
          mkdir -p data/raw
          if [ ! -f data/raw/UCI_Credit_Card.csv ]; then
            pip install xlrd
            curl -L -o data.zip "https://archive.ics.uci.edu/static/public/350/default+of+credit+card+clients.zip"
            unzip -o data.zip
            python -c "
import pandas as pd
df = pd.read_excel('default of credit card clients.xls', header=1)
df.to_csv('data/raw/UCI_Credit_Card.csv', index=False)
"
          fi

      - name: Prepare data
        run: |
          python src/data/make_dataset.py data/raw/UCI_Credit_Card.csv data/processed/

      - name: Run Black
        run: black --check src tests

      - name: Run Flake8
        run: flake8 src tests --max-line-length=88 --extend-ignore=E203,W503

      - name: Валидация данных (Pandera)
        run: python -c "
from src.data.validation import validate_data_file
from pathlib import Path
train_path = Path('data/processed/train.csv')
assert train_path.exists(), 'Данные train не найдены'
validate_data_file(train_path)
print('Валидация Pandera пройдена')
"

      - name: Валидация данных (Great Expectations)
        run: |
          pip install great-expectations==0.18.21
          python scripts/validate_ge.py

      - name: Run tests
        run: pytest tests -v
